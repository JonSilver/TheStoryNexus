import {
    AlertCircle, BookOpen, CheckCircle, ChevronDown, FolderTree,
    GripVertical, Layers, Link as LinkIcon, Pencil, Trash2
} from "lucide-react";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Step, Tip, Warning, Important, InfoCard, CardGrid, FeatureCard, FeatureGrid, Summary, SubStep, CodeExample } from "../components/mdx";

# Advanced Features Guide

Master advanced features including series management, hierarchical lorebooks, and workflow optimisation to take your writing to the next level.

<Tabs defaultValue="series" className="w-full">
    <TabsList className="grid grid-cols-5 mb-8">
        <TabsTrigger value="series">Series</TabsTrigger>
        <TabsTrigger value="content">Content Management</TabsTrigger>
        <TabsTrigger value="workflow">Workflow & Shortcuts</TabsTrigger>
        <TabsTrigger value="troubleshooting">Troubleshooting</TabsTrigger>
        <TabsTrigger value="future">Future Topics</TabsTrigger>
    </TabsList>

    <TabsContent value="series" className="space-y-6">
        ## Working with Series

        Series provide a powerful way to organise interconnected stories that share world-building, characters, or timelines. Understanding when and how to use series effectively can significantly improve your writing workflow.

        <CardGrid>
            <InfoCard icon={CheckCircle} title="When to Use Series">
                - Multiple books in the same universe
                - Sequels, prequels, or spin-offs
                - Shared world with different protagonists
                - Anthology stories with common elements
                - Stories spanning a connected timeline
            </InfoCard>

            <InfoCard icon={CheckCircle} title="Benefits of Series">
                - Shared lorebook entries across all stories
                - Consistent world-building automatically
                - Organised dashboard for related works
                - Easy navigation between connected stories
                - Unified character and location management
            </InfoCard>
        </CardGrid>

        <SubStep title="Creating and Managing Series">
            **1. Creating a Series**
            Navigate to the Series page from the home screen. Click "Create New Series" and provide a name and optional description. The description helps you remember what connects the stories in this series.

            **2. Adding Stories to a Series**
            From the series dashboard, click "Create New Story". Stories created this way automatically belong to the series. You can also assign existing standalone stories to a series by editing the story's details.

            **3. Accessing Series Lorebook**
            The series dashboard includes a Lorebook tab. Entries created at the series level are accessible to all stories in the series, perfect for recurring characters, shared locations, or universal world rules.
        </SubStep>

        <SubStep title="Series Lorebook Strategy">
            Deciding what goes in the series lorebook versus individual story lorebooks is crucial for effective organisation.

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                <FeatureCard icon={FolderTree} title="Global Level">
                    Use for:
                    - Writing style guides
                    - Universal themes
                    - Cross-series concepts
                </FeatureCard>

                <FeatureCard icon={Layers} title="Series Level">
                    Use for:
                    - Recurring characters
                    - Shared locations
                    - Series-wide timeline
                    - Common lore/magic
                </FeatureCard>

                <FeatureCard icon={BookOpen} title="Story Level">
                    Use for:
                    - Story-unique characters
                    - Specific plot locations
                    - One-off items/events
                    - Story-specific notes
                </FeatureCard>
            </div>
        </SubStep>

        <Summary title="Series Best Practices">
            <div className="flex items-start gap-2 mb-3">
                <CheckCircle className="h-4 w-4 text-primary mt-0.5" />
                <div>
                    **Plan Your Hierarchy Early**
                    Before creating multiple stories, decide what elements should be shared across the series. Moving entries between levels later is possible but planning prevents reorganisation work.
                </div>
            </div>

            <div className="flex items-start gap-2 mb-3">
                <CheckCircle className="h-4 w-4 text-primary mt-0.5" />
                <div>
                    **Use Consistent Naming**
                    If a character appears across multiple stories, use the same tags and naming in series-level entries. This ensures the AI recognises them consistently.
                </div>
            </div>

            <div className="flex items-start gap-2 mb-3">
                <CheckCircle className="h-4 w-4 text-primary mt-0.5" />
                <div>
                    **Update Series Entries as Stories Progress**
                    When characters develop or world elements evolve across stories, update the series lorebook entries to reflect the current state. This keeps AI context accurate across all stories.
                </div>
            </div>

            <div className="flex items-start gap-2">
                <CheckCircle className="h-4 w-4 text-primary mt-0.5" />
                <div>
                    **Consider Chronological Order**
                    Even if you're not writing in chronological order, note the timeline in series lorebook entries. This helps maintain continuity when jumping between different points in your story universe.
                </div>
            </div>
        </Summary>

        <Tip title="Converting Standalone Stories to Series">
            If you start with a standalone story and later decide to create a series, simply create the series and edit your story to assign it to the series. Any story-level lorebook entries remain at the story level—you can manually promote shared elements to the series level as needed.
        </Tip>
    </TabsContent>

    <TabsContent value="content" className="space-y-6">
        ## Managing Your Content

        Master the tools for managing stories, chapters, and notes to keep your writing organised and accessible.

        <SubStep title="Chapter Management">
            Chapters can be managed from the Chapters page in your story dashboard.

            <div className="space-y-4 mt-4">
                <div>
                    <h4 className="font-medium text-sm mb-2 flex items-center gap-2">
                        <GripVertical className="h-4 w-4 text-primary" />
                        Reordering Chapters
                    </h4>
                    <p className="text-sm text-muted-foreground ml-6">
                        Drag and drop chapters by the grip handle (six dots) on the left side of each chapter card. The order updates automatically and affects chapter numbering and summary context.
                    </p>
                </div>

                <div>
                    <h4 className="font-medium text-sm mb-2 flex items-center gap-2">
                        <Pencil className="h-4 w-4 text-primary" />
                        Editing Chapter Details
                    </h4>
                    <p className="text-sm text-muted-foreground ml-6">Click the edit icon on a chapter card to modify:</p>
                    <ul className="list-disc list-inside space-y-1 text-sm text-muted-foreground ml-12 mt-1">
                        <li>**Title:** Change the chapter title</li>
                        <li>**POV Type:** First Person, Third Person Limited, or Third Person Omniscient</li>
                        <li>**POV Character:** Select from your lorebook characters (disabled for Omniscient POV)</li>
                    </ul>
                </div>

                <div>
                    <h4 className="font-medium text-sm mb-2 flex items-center gap-2">
                        <ChevronDown className="h-4 w-4 text-primary" />
                        Viewing & Editing Summaries
                    </h4>
                    <p className="text-sm text-muted-foreground ml-6">Click the expand arrow on a chapter card to view its summary. You can:</p>
                    <ul className="list-disc list-inside space-y-1 text-sm text-muted-foreground ml-12 mt-1">
                        <li>Edit the summary directly in the textarea</li>
                        <li>Generate a new summary using the AI (select a "Generate Summary" prompt and model)</li>
                        <li>Export the chapter to various formats using the download menu</li>
                    </ul>
                </div>

                <div>
                    <h4 className="font-medium text-sm mb-2 flex items-center gap-2">
                        <Trash2 className="h-4 w-4 text-destructive" />
                        Deleting Chapters
                    </h4>
                    <p className="text-sm text-muted-foreground ml-6">
                        Click the delete icon on a chapter card. You'll be asked to confirm. **Deletion is permanent and cannot be undone.** All chapter content, notes, outlines, and scene beats are deleted.
                    </p>
                </div>

                <div>
                    <h4 className="font-medium text-sm mb-2">Chapter Notes & Outlines</h4>
                    <p className="text-sm text-muted-foreground ml-6">Access notes and outlines from within the chapter editor:</p>
                    <ul className="list-disc list-inside space-y-1 text-sm text-muted-foreground ml-12 mt-1">
                        <li>**Outline:** Plan your chapter structure, scene beats, and plot points before writing</li>
                        <li>**Notes:** Track character arcs, continuity reminders, or revision notes for this specific chapter</li>
                        <li>Both persist automatically and are accessible from the editor sidebar or toolbar</li>
                    </ul>
                </div>
            </div>
        </SubStep>

        <SubStep title="Story Management">
            Manage story metadata and settings from the Stories page.

            <div className="space-y-4 mt-4">
                <div>
                    <h4 className="font-medium text-sm mb-2">Editing Story Details</h4>
                    <p className="text-sm text-muted-foreground ml-6">From the Stories page, click the edit icon on a story card to modify:</p>
                    <ul className="list-disc list-inside space-y-1 text-sm text-muted-foreground ml-12 mt-1">
                        <li>**Title:** Story title</li>
                        <li>**Author:** Author name</li>
                        <li>**Language:** Primary story language (used in AI prompts)</li>
                        <li>**Synopsis:** Brief story description or summary</li>
                        <li>**Series:** Assign to a series or change series assignment (leave blank for standalone)</li>
                    </ul>
                </div>

                <div>
                    <h4 className="font-medium text-sm mb-2">Converting Standalone to Series Story</h4>
                    <ol className="list-decimal list-inside space-y-1 text-sm text-muted-foreground ml-6">
                        <li>Create a series from the Series page if you haven't already</li>
                        <li>Edit your standalone story details</li>
                        <li>Select the series from the "Series" dropdown</li>
                        <li>Save changes</li>
                        <li>Your story now has access to series-level lorebook entries</li>
                    </ol>
                </div>

                <div>
                    <h4 className="font-medium text-sm mb-2 flex items-center gap-2">
                        <Trash2 className="h-4 w-4 text-destructive" />
                        Deleting Stories
                    </h4>
                    <p className="text-sm text-muted-foreground ml-6">
                        Click the delete icon on a story card and confirm. **This permanently deletes the story and all its chapters, prompts, lorebook entries, notes, brainstorm chats, and scene beats.** Consider exporting before deletion if you want to keep a backup.
                    </p>
                </div>
            </div>
        </SubStep>

        <SubStep title="Notes Feature">
            The Notes feature provides story-level note-taking separate from chapter notes. Access it from the "Notes" tab in your story dashboard.

            <CardGrid>
                <InfoCard title="When to Use Notes">
                    - Story-wide ideas and brainstorming
                    - Research and reference material
                    - Todo lists for revision or editing
                    - General notes not tied to specific chapters
                </InfoCard>

                <InfoCard title="Note Types">
                    - **Idea:** Plot ideas, character concepts
                    - **Research:** Background research, references
                    - **Todo:** Tasks, revisions, editing notes
                    - **Other:** Anything else
                </InfoCard>
            </CardGrid>

            <div className="mt-4">
                <h4 className="font-medium text-sm mb-2">Using Notes</h4>
                <ol className="list-decimal list-inside space-y-2 text-sm text-muted-foreground ml-6">
                    <li>Navigate to Dashboard → [Your Story] → Notes</li>
                    <li>Click "Create New Note" in the sidebar</li>
                    <li>Enter a title and select a note type</li>
                    <li>Write your note content in the editor</li>
                    <li>Notes save automatically</li>
                    <li>Click on notes in the sidebar to switch between them</li>
                    <li>Delete notes using the delete button when a note is selected</li>
                </ol>
            </div>

            <Tip title="Notes vs Chapter Notes vs Lorebook">
                - **Story Notes:** General story-wide information, not tied to chapters
                - **Chapter Notes:** Specific to one chapter, accessed from chapter editor
                - **Lorebook Notes Category:** Story elements visible to AI during generation
            </Tip>
        </SubStep>
    </TabsContent>

    <TabsContent value="workflow" className="space-y-6">
        ## Optimising Your Writing Workflow

        Effective workflow habits help you make the most of The Story Nexus's features and maintain creative momentum.

        <SubStep title="Lorebook-First Approach">
            Before diving into writing, spend time building your lorebook. This upfront investment pays dividends when the AI has rich context from the start.

            <CodeExample title="Recommended Workflow:">
                1. Create core character entries with personality, background, and goals
                2. Define key locations with atmospheric details
                3. Document your magic system, technology, or unique world rules
                4. Add timeline entries for major historical events
                5. Begin writing with confidence that the AI understands your world
            </CodeExample>
        </SubStep>

        <SubStep title="Chapter Planning with Notes and Outlines">
            Each chapter supports both notes and outlines. Use them to stay organised:

            <FeatureGrid cols={2}>
                <FeatureCard icon={BookOpen} title="Chapter Outlines">
                    Plan scene beats, plot points, and structure before writing. Refer back as you write to stay on track.
                </FeatureCard>
                <FeatureCard icon={BookOpen} title="Chapter Notes">
                    Track character arcs, continuity details, or revision reminders. Notes persist alongside your chapter.
                </FeatureCard>
            </FeatureGrid>
        </SubStep>

        <SubStep title="Using Brainstorming Effectively">
            Don't wait until you're stuck to brainstorm. Proactive brainstorming prevents writer's block:

            - Brainstorm upcoming plot points before reaching them
            - Explore character motivations when planning scenes
            - Test "what if" scenarios to find the most compelling direction
            - Use brainstorming to work through logic issues in your plot
        </SubStep>

        <SubStep title="Summary Generation Strategy">
            Chapter summaries help the AI maintain continuity across your story. Generate summaries after completing each chapter:

            <CodeExample>
                1. Write your chapter to completion
                2. Use a "Generate Summary" prompt to create a concise summary
                3. Review and edit the summary to emphasise key plot points
                4. Save the summary—it automatically becomes context for future chapters
            </CodeExample>
        </SubStep>

        <SubStep title="Keyboard Shortcuts Reference">
            Master these shortcuts to speed up your writing workflow.

            <CardGrid>
                <InfoCard title="Editor Shortcuts">
                    <div className="space-y-2 text-sm">
                        <div className="flex justify-between">
                            <span>Insert Scene Beat</span>
                            <kbd className="px-2 py-1 bg-muted rounded border text-xs">Alt+S / Opt+S</kbd>
                        </div>
                        <div className="flex justify-between">
                            <span>Trigger @ Autocomplete</span>
                            <kbd className="px-2 py-1 bg-muted rounded border text-xs">@</kbd>
                        </div>
                        <div className="flex justify-between">
                            <span>Save Chapter</span>
                            <kbd className="px-2 py-1 bg-muted rounded border text-xs">Auto-save</kbd>
                        </div>
                    </div>
                </InfoCard>

                <InfoCard title="Navigation Tips">
                    - Use browser back/forward for navigation
                    - Story dashboard tabs accessible via mouse
                    - Most features keyboard-accessible via Tab key
                </InfoCard>
            </CardGrid>
        </SubStep>
    </TabsContent>

    <TabsContent value="troubleshooting" className="space-y-6">
        ## Troubleshooting Common Issues

        Solutions to common problems you might encounter while using The Story Nexus.

        <div className="space-y-4 border-l-4 border-destructive pl-4 py-2">
            ### AI Generation Issues

            <div className="space-y-3">
                <div className="border rounded-lg p-4 bg-card">
                    <h4 className="font-medium text-sm mb-2">Models Don't Appear After Adding API Key</h4>
                    <p className="text-sm text-muted-foreground mb-2">**For OpenAI/OpenRouter:**</p>
                    <ul className="list-disc list-inside space-y-1 text-sm text-muted-foreground ml-4">
                        <li>Wait a few seconds - models fetch automatically after key is saved</li>
                        <li>Check that your API key is valid (test it at the provider's website)</li>
                        <li>Ensure you have internet connectivity</li>
                        <li>Try refreshing the page</li>
                    </ul>
                    <p className="text-sm text-muted-foreground mt-2 mb-2">**For Local Models:**</p>
                    <ul className="list-disc list-inside space-y-1 text-sm text-muted-foreground ml-4">
                        <li>Ensure LM Studio (or your local AI server) is running</li>
                        <li>Check the API URL is correct (default: http://localhost:1234/v1)</li>
                        <li>Click the "Refresh Models" button after starting your local server</li>
                        <li>Verify a model is loaded in LM Studio</li>
                    </ul>
                </div>

                <div className="border rounded-lg p-4 bg-card">
                    <h4 className="font-medium text-sm mb-2">Scene Beat Won't Generate</h4>
                    <p className="text-sm text-muted-foreground mb-2">Check these requirements:</p>
                    <ul className="list-disc list-inside space-y-1 text-sm text-muted-foreground ml-4">
                        <li>You've entered a scene beat command</li>
                        <li>You've selected a prompt from the dropdown</li>
                        <li>You've selected a model from the dropdown</li>
                        <li>The "Generate Prose" button should become active when all three are set</li>
                        <li>If using a local model, ensure your server is running and responsive</li>
                    </ul>
                </div>

                <div className="border rounded-lg p-4 bg-card">
                    <h4 className="font-medium text-sm mb-2">Generation Fails or Returns Error</h4>
                    <p className="text-sm text-muted-foreground mb-2">Common causes:</p>
                    <ul className="list-disc list-inside space-y-1 text-sm text-muted-foreground ml-4">
                        <li>**API Key Issues:** Invalid or expired key, insufficient credits</li>
                        <li>**Rate Limits:** You may have hit provider rate limits - wait and try again</li>
                        <li>**Context Too Large:** Too much lorebook context or chapter content. Try using "Use Custom Context" with fewer entries</li>
                        <li>**Local Server:** Server crashed or model unloaded - restart LM Studio</li>
                        <li>**Network Issues:** Check internet connection for cloud providers</li>
                    </ul>
                </div>

                <div className="border rounded-lg p-4 bg-card">
                    <h4 className="font-medium text-sm mb-2">Generation is Slow</h4>
                    <p className="text-sm text-muted-foreground mb-2">Speed factors:</p>
                    <ul className="list-disc list-inside space-y-1 text-sm text-muted-foreground ml-4">
                        <li>**Local Models:** Speed depends on your hardware (CPU/GPU)</li>
                        <li>**Cloud Models:** Network speed and provider server load affect generation</li>
                        <li>**Context Size:** More lorebook entries = slower generation. Use selective context</li>
                        <li>**Max Tokens:** Higher max tokens = longer generation time</li>
                    </ul>
                </div>
            </div>
        </div>

        <div className="space-y-4 border-l-4 border-destructive pl-4 py-2">
            ### Lorebook Issues

            <div className="space-y-3">
                <div className="border rounded-lg p-4 bg-card">
                    <h4 className="font-medium text-sm mb-2">Entries Not Matching in Text</h4>
                    <ul className="list-disc list-inside space-y-1 text-sm text-muted-foreground ml-4">
                        <li>Check that entry is not disabled (eye icon should show enabled)</li>
                        <li>Ensure tags include the exact text you're typing (case-insensitive match)</li>
                        <li>Remember the entry name is automatically a tag</li>
                        <li>Tags with special characters or spaces should still match</li>
                    </ul>
                </div>

                <div className="border rounded-lg p-4 bg-card">
                    <h4 className="font-medium text-sm mb-2">Can't See Series Lorebook Entries in Story</h4>
                    <ul className="list-disc list-inside space-y-1 text-sm text-muted-foreground ml-4">
                        <li>Verify your story is assigned to a series (edit story details to check)</li>
                        <li>Series entries show with "Series" badge - look for the level badge on each entry</li>
                        <li>If you just assigned the story to a series, try refreshing the page</li>
                    </ul>
                </div>
            </div>
        </div>

        <div className="space-y-4 border-l-4 border-destructive pl-4 py-2">
            ### Data & Storage Issues

            <div className="space-y-3">
                <div className="border rounded-lg p-4 bg-card">
                    <h4 className="font-medium text-sm mb-2">Changes Not Saving</h4>
                    <ul className="list-disc list-inside space-y-1 text-sm text-muted-foreground ml-4">
                        <li>**Chapter Content:** Auto-saves as you type with debounce - wait a moment after stopping typing</li>
                        <li>**Other Fields:** Most save when you click Save/Update buttons or close dialogs</li>
                        <li>Check browser console for errors (F12 → Console tab)</li>
                        <li>Ensure you're not running out of disk space (SQLite database)</li>
                    </ul>
                </div>

                <div className="border rounded-lg p-4 bg-card">
                    <h4 className="font-medium text-sm mb-2">Where is My Data Stored?</h4>
                    <p className="text-sm text-muted-foreground mb-2">All data is stored locally in an SQLite database on your machine:</p>
                    <ul className="list-disc list-inside space-y-1 text-sm text-muted-foreground ml-4">
                        <li>Database location depends on your installation method</li>
                        <li>Nothing is sent to cloud (except AI API calls for generation)</li>
                        <li>Back up the database file regularly if you want to preserve your work</li>
                        <li>Consider using export features for additional backups</li>
                    </ul>
                </div>
            </div>
        </div>

        <Tip title="Still Having Issues?">
            If you encounter persistent problems:
            - Check the browser console (F12) for error messages
            - Try refreshing the page or restarting the application
            - Report issues at: [GitHub Issues](https://github.com/JonSilver/TheStoryNexus/issues)
        </Tip>
    </TabsContent>

    <TabsContent value="future" className="space-y-6">
        ## Future Guide Topics

        The following topics are planned for future guide updates:

        <Tip title="Coming Soon">
            These topics are under development. Check back for updates as new features are documented.
        </Tip>

        <CardGrid>
            <InfoCard title="Export & Archiving">
                - Exporting stories in multiple formats
                - Backing up your work
                - Archiving completed projects
            </InfoCard>

            <InfoCard title="Advanced Editor Features">
                - Custom keyboard shortcuts
                - Editor customisation options
                - Advanced formatting techniques
            </InfoCard>

            <InfoCard title="AI Model Optimisation">
                - Choosing the right model for different tasks
                - Understanding temperature and token settings
                - Prompt engineering best practices
            </InfoCard>

            <InfoCard title="Collaboration & Sharing">
                - Sharing prompts and lorebooks
                - Collaborative workflows (future feature)
                - Community prompt libraries
            </InfoCard>
        </CardGrid>
    </TabsContent>
</Tabs>
